<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Human Anatomy Explorer | Interactive 3D Learning</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap">
  <style>
    /* Custom Science/Space Theme */
    :root {
      --primary: #4F46E5;
      --primary-hover: #4338CA;
      --secondary: #10B981;
      --accent: #06B6D4;
      --dark-bg: #111827;
      --panel-bg: #1F2937;
      --text-primary: #F9FAFB;
      --text-secondary: #D1D5DB;
      --glow-primary: 0 0 15px rgba(99, 102, 241, 0.5);
      --glow-secondary: 0 0 15px rgba(16, 185, 129, 0.5);
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      overflow: hidden;
      background-color: var(--dark-bg);
      color: var(--text-primary);
    }
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Rajdhani', sans-serif;
      font-weight: 600;
    }
    .sci-panel {
      background-color: rgba(31, 41, 55, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), var(--glow-primary);
    }
    .sci-title {
      position: relative;
      overflow: hidden;
    }
    .sci-title::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
      background: linear-gradient(180deg, var(--primary), var(--secondary));
    }
    .sci-badge {
      background: linear-gradient(45deg, var(--primary), var(--accent));
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .sci-highlight {
      color: var(--secondary);
      font-weight: 500;
    }
    .glow-text {
      text-shadow: 0 0 8px rgba(99, 102, 241, 0.6);
    }
    /* Canvas Styling */
    #canvas-container {
      flex-grow: 1;
      height: 100vh;
      position: relative;
    }
    #canvas-container canvas {
      display: block;
      width: 100%;
      height: 100%;
      cursor: grab;
    }
    #canvas-container canvas:active {
      cursor: grabbing;
    }
    /* Sidebar Panel */
    #info-panel {
      width: 375px;
      height: 100vh;
      overflow-y: auto;
      flex-shrink: 0;
      background-color: var(--panel-bg);
      transition: transform 0.3s ease;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) var(--panel-bg);
    }
    #info-panel::-webkit-scrollbar {
      width: 8px;
    }
    #info-panel::-webkit-scrollbar-track {
      background: var(--panel-bg);
    }
    #info-panel::-webkit-scrollbar-thumb {
      background-color: var(--primary);
      border-radius: 20px;
    }
    /* Loading Overlay */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(17, 24, 39, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
    .progress-bar {
      width: 300px;
      height: 8px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 2rem;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      width: 0%;
      transition: width 0.3s ease;
      box-shadow: var(--glow-primary);
    }
    /* Controls Guide */
    #controls-guide {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      background-color: rgba(31, 41, 55, 0.8);
      color: white;
      font-size: 0.75rem;
      line-height: 1.25rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      z-index: 10;
      max-width: 250px;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(99, 102, 241, 0.15);
      transition: opacity 0.3s;
      opacity: 0.7;
    }
    #controls-guide:hover {
      opacity: 1;
    }
    /* HUD Elements */
    .hud-element {
      position: absolute;
      pointer-events: none;
      z-index: 5;
      font-family: 'Rajdhani', sans-serif;
    }
    .body-stat {
      top: 1rem;
      left: 1rem;
      font-size: 0.8rem;
      padding: 0.75rem;
      color: var(--text-secondary);
      max-width: 250px;
    }
    .body-scan-line {
      position: absolute;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, 
          transparent, 
          rgba(99, 102, 241, 0.2), 
          rgba(99, 102, 241, 0.5), 
          rgba(99, 102, 241, 0.2), 
          transparent);
      z-index: 10;
      pointer-events: none;
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.4);
      opacity: 0;
      animation: scanAnimation 8s infinite;
    }
    @keyframes scanAnimation {
      0% { top: 0%; opacity: 1; }
      90% { top: 100%; opacity: 1; }
      91% { opacity: 0; }
      100% { top: 0%; opacity: 0; }
    }
    /* HUD Trackers */
    .tracker {
      position: absolute;
      width: 80px;
      height: 80px;
      pointer-events: none;
      z-index: 5;
      border: 1px solid rgba(99, 102, 241, 0.5);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      background: radial-gradient(circle, 
          rgba(99, 102, 241, 0.15) 0%, 
          rgba(16, 185, 129, 0.05) 70%, 
          transparent 100%);
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
      opacity: 0;
      transition: opacity 0.5s;
    }
    .tracker::before, .tracker::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
    }
    .tracker::before {
      width: 60px;
      height: 60px;
      border: 1px dashed rgba(99, 102, 241, 0.5);
      animation: rotate 10s linear infinite;
    }
    .tracker::after {
      width: 10px;
      height: 10px;
      background-color: rgba(16, 185, 129, 0.8);
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.8);
    }
    @keyframes rotate {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    /* Augmented Reality Styled Labels */
    .ar-label {
      position: absolute;
      color: var(--secondary);
      font-size: 0.7rem;
      letter-spacing: 0.05em;
      pointer-events: none;
      z-index: 5;
      transition: opacity 0.5s;
      opacity: 0;
      text-shadow: 0 0 5px var(--secondary);
    }
    .ar-label::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 30px;
      height: 1px;
      background-color: var(--secondary);
      opacity: 0.5;
    }
    .ar-label-left {
      text-align: right;
    }
    .ar-label-left::after {
      right: -35px;
    }
    .ar-label-right {
      text-align: left;
    }
    .ar-label-right::after {
      left: -35px;
    }
    .info-card {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s, transform 0.5s;
    }
    .info-card.show {
      opacity: 1;
      transform: translateY(0);
    }
    /* Responsive Styles */
    @media (max-width: 768px) {
      .flex-col-reverse { flex-direction: column-reverse; }
      #info-panel {
        width: 100%;
        height: 40%;
        min-height: 250px;
        max-height: 50%;
      }
      #canvas-container {
        height: 60%;
      }
      .panel-toggle {
        display: block !important;
      }
      #info-panel.collapsed {
        transform: translateY(calc(100% - 40px));
      }
      #toggle-panel-icon {
        transform: rotate(0deg);
        transition: transform 0.3s;
      }
      #info-panel.collapsed #toggle-panel-icon {
        transform: rotate(180deg);
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loading-overlay">
    <h2 class="text-4xl font-bold text-center mb-2 glow-text">Loading Human Anatomy Explorer</h2>
    <p class="text-gray-400 mb-6">Preparing high-resolution 3D model...</p>
    <div class="progress-bar">
      <div class="progress-fill" id="progress-bar"></div>
    </div>
    <p id="loading-text" class="mt-4 text-sm text-gray-300">Establishing connection...</p>
  </div>

  <div class="flex h-screen md:flex-row flex-col-reverse">
    <!-- Information Panel -->
    <div id="info-panel" class="relative">
      <!-- Mobile Toggle -->
      <button id="panel-toggle" class="panel-toggle hidden absolute top-4 right-4 md:hidden bg-gray-700 p-2 rounded-md hover:bg-gray-600 focus:outline-none">
        <svg id="toggle-panel-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
      <!-- Header Section -->
      <div class="p-6">
        <div class="sci-title pl-6 mb-4">
          <h1 class="text-2xl font-bold">Human Anatomy Explorer</h1>
          <p class="text-sm text-gray-400">Interactive 3D Learning Platform</p>
        </div>
        <div class="flex items-center space-x-2 mb-4">
          <div class="sci-badge bg-indigo-700 text-indigo-50">
            <span class="opacity-60">SCI</span><span>SCAN</span>
          </div>
          <div class="h-2 w-2 rounded-full bg-green-400 animate-pulse"></div>
          <div class="text-xs text-green-400">ACTIVE</div>
        </div>
      </div>
      <!-- Content Section -->
      <div id="info-content" class="px-6 pb-6 space-y-4">
        <div class="sci-panel p-4 info-card show">
          <p class="text-gray-300 text-sm">
            Welcome to the <span class="sci-highlight">Human Anatomy Explorer</span>.
            This interactive model allows you to explore the human body in 3D.
          </p>
          <p class="text-gray-300 text-sm mt-2">
            Click on a body part to learn more about its structure and function.
          </p>
        </div>
      </div>
    </div>

    <!-- 3D Canvas Container -->
    <div id="canvas-container" class="relative">
      <!-- HUD Elements -->
      <div class="hud-element body-stat sci-panel">
        <div class="text-xs text-indigo-300 mb-1">ANATOMICAL ANALYSIS</div>
        <div class="text-xs">
          <span>SYSTEM</span>: <span id="system-status" class="text-green-400">STANDBY</span>
        </div>
        <div class="text-xs">
          <span>ORGANS MAPPED</span>: <span class="text-yellow-400">5</span>
        </div>
      </div>
      <!-- Scan Line Animation -->
      <div class="body-scan-line"></div>
      <!-- Target Tracker (will be positioned in JS) -->
      <div id="body-tracker" class="tracker"></div>
      <!-- AR Labels (will be positioned in JS) -->
      <div id="head-label" class="ar-label ar-label-left">CEPHALIC REGION</div>
      <div id="torso-label" class="ar-label ar-label-right">THORACIC CAVITY</div>
      <div id="arm-label" class="ar-label ar-label-left">UPPER LIMB</div>
      <div id="leg-label" class="ar-label ar-label-right">LOWER LIMB</div>
      <!-- Controls Guide -->
      <div id="controls-guide" class="sci-panel">
        <div class="text-xs text-indigo-300 mb-1 font-semibold">INTERFACE CONTROLS</div>
        <div class="grid grid-cols-2 gap-x-3 gap-y-1 text-xs">
          <span>ROTATE VIEW</span><span class="text-gray-300">Left Mouse / Drag</span>
          <span>ZOOM</span><span class="text-gray-300">Mouse Wheel</span>
          <span>PAN</span><span class="text-gray-300">Right Mouse / Drag</span>
          <span>RESET VIEW</span><span class="text-gray-300">Double Click</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Audio Elements -->
  <audio id="sound-click" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-modern-technology-select-3124.mp3" type="audio/mpeg">
  </audio>
  <audio id="sound-hover" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-interface-hint-notification-911.mp3" type="audio/mpeg">
  </audio>
  <audio id="sound-scan" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-sci-fi-interface-zoom-890.mp3" type="audio/mpeg">
  </audio>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { OutlinePass } from 'three/addons/postprocessing/OutlinePass.js';

    // --- Global Variables ---
    let scene, camera, renderer, controls, composer;
    let raycaster, mouse;
    let model;
    let bloomPass, outlinePass;
    let selectedPart = null;
    let initialCameraPosition = new THREE.Vector3();
    let initialControlsTarget = new THREE.Vector3();
    let arLabels = {};
    let tracker = document.getElementById('body-tracker');
    let audioEnabled = true;

    // DOM elements
    const canvasContainer = document.getElementById('canvas-container');
    const infoContent = document.getElementById('info-content');
    const loadingOverlay = document.getElementById('loading-overlay');
    const progressBar = document.getElementById('progress-bar');
    const loadingText = document.getElementById('loading-text');
    const panelToggle = document.getElementById('panel-toggle');
    const infoPanel = document.getElementById('info-panel');
    const systemStatus = document.getElementById('system-status');

    // Audio elements
    const soundClick = document.getElementById('sound-click');
    const soundHover = document.getElementById('sound-hover');
    const soundScan = document.getElementById('sound-scan');

    // Detailed information for each body part.
    // Adjusted the Z coordinates by +1.6 units to match the actual model orientation.
    const bodyPartsData = {
      head: {
        name: "Head",
        system: "Nervous System",
        description: `
          <p>The head houses the brain, the command center of the body's central nervous system, protected by the skull. It contains major sensory organs including the eyes, ears, nose, and mouth.</p>
          <p>These organs collect information from the environment and transmit it to the brain for processing, enabling sight, hearing, smell, and taste.</p>
        `,
        composition: ["Brain", "Skull", "Eyes", "Ears", "Nose", "Mouth"],
        functions: [
          "Processes sensory information",
          "Controls cognitive functions",
          "Houses communication organs",
          "Initiates digestion through the mouth",
          "Protects the brain from trauma"
        ],
        // Original zone was roughly (-0.4,2.4,-0.4) to (0.4,3.1,0.4).
        // Here we add +1.6 to the z-values.
        zone: new THREE.Box3(
          new THREE.Vector3(-0.4, 2.4, 1.2),
          new THREE.Vector3(0.4, 3.1, 2.0)
        )
      },
      chest: {
        name: "Chest/Torso",
        system: "Respiratory & Cardiovascular Systems",
        description: `
          <p>The chest, or thoracic cavity, is protected by the ribcage and contains vital organs including the heart and lungs. The heart pumps blood throughout the body, while the lungs enable respiration.</p>
          <p>This region also includes the esophagus, which carries food from the mouth to the stomach, and houses major blood vessels like the aorta.</p>
        `,
        composition: ["Heart", "Lungs", "Ribcage", "Esophagus", "Thoracic Vertebrae"],
        functions: [
          "Circulates blood throughout the body",
          "Facilitates gas exchange (oxygen intake and carbon dioxide expulsion)",
          "Protects vital organs with bone structure",
          "Connects respiratory and digestive systems",
          "Supports upper body mobility"
        ],
        zone: new THREE.Box3(
          new THREE.Vector3(-0.5, 0.9, 1.2),
          new THREE.Vector3(0.5, 2.4, 2.0)
        )
      },
      abdomen: {
        name: "Abdomen",
        system: "Digestive & Urinary Systems",
        description: `
          <p>The abdomen contains the majority of the digestive system organs, including the stomach, liver, pancreas, gallbladder, and intestines. It's also home to other vital organs like the kidneys, which filter blood.</p>
          <p>The abdominal muscles provide stability and protection for these internal organs, while also enabling trunk movement and maintaining posture.</p>
        `,
        composition: ["Stomach", "Liver", "Intestines", "Kidneys", "Pancreas", "Gallbladder"],
        functions: [
          "Digests and processes nutrients from food",
          "Filters waste from blood",
          "Produces digestive enzymes and hormones",
          "Detoxifies harmful substances",
          "Stores energy in the form of glycogen and fat"
        ],
        zone: new THREE.Box3(
          new THREE.Vector3(-0.5, 0.0, 1.2),
          new THREE.Vector3(0.5, 0.9, 2.0)
        )
      },
      leftArm: {
        name: "Left Arm",
        system: "Musculoskeletal System",
        description: `
          <p>The arm extends from the shoulder to the hand and consists of the upper arm (containing the humerus bone), the elbow joint, and the forearm (containing the radius and ulna bones).</p>
          <p>Arms contain complex networks of muscles, tendons, ligaments, blood vessels, and nerves that work together to enable precise movements and sensations.</p>
        `,
        composition: ["Humerus", "Radius", "Ulna", "Muscles", "Tendons", "Blood vessels", "Nerves"],
        functions: [
          "Enables lifting and carrying objects",
          "Allows fine motor manipulation",
          "Provides tactile sensation",
          "Assists with balance and coordination",
          "Enables pushing and pulling motions"
        ],
        zone: new THREE.Box3(
          new THREE.Vector3(-1.0, 0.8, 1.2),
          new THREE.Vector3(-0.4, 2.3, 2.0)
        )
      },
      rightArm: {
        name: "Right Arm",
        system: "Musculoskeletal System",
        description: `
          <p>The arm extends from the shoulder to the hand and consists of the upper arm (containing the humerus bone), the elbow joint, and the forearm (containing the radius and ulna bones).</p>
          <p>Arms contain complex networks of muscles, tendons, ligaments, blood vessels, and nerves that work together to enable precise movements and sensations.</p>
        `,
        composition: ["Humerus", "Radius", "Ulna", "Muscles", "Tendons", "Blood vessels", "Nerves"],
        functions: [
          "Enables lifting and carrying objects",
          "Allows fine motor manipulation",
          "Provides tactile sensation",
          "Assists with balance and coordination",
          "Enables pushing and pulling motions"
        ],
        zone: new THREE.Box3(
          new THREE.Vector3(0.4, 0.8, 1.2),
          new THREE.Vector3(1.0, 2.3, 2.0)
        )
      },
      legs: {
        name: "Legs",
        system: "Musculoskeletal System",
        description: `
          <p>The legs are composed of the thigh (containing the femur, the body's longest bone), the knee joint, the lower leg (tibia and fibula), and the ankle and foot.</p>
          <p>Powerful muscles in the legs, including the quadriceps and hamstrings, enable standing, walking, running, and jumping, while also supporting the body's weight.</p>
        `,
        composition: ["Femur", "Tibia", "Fibula", "Patella", "Muscles", "Tendons", "Joints"],
        functions: [
          "Supports body weight",
          "Enables locomotion (walking, running, jumping)",
          "Maintains balance and stability",
          "Absorbs impact during movement",
          "Assists in generating force for physical activities"
        ],
        zone: new THREE.Box3(
          new THREE.Vector3(-0.5, -1.5, 1.2),
          new THREE.Vector3(0.5, 0.0, 2.0)
        )
      }
    };

    // --- Initialization ---
    function init() {
      initSceneAndCamera();
      setupRenderer();
      setupLighting();
      setupPostProcessing();
      setupControls();
      setupRaycaster();
      setupARElements();
      loadEnvironmentMap();
      loadModel();
      setupEventListeners();
      animate();
    }

    // --- Setup Scene and Camera ---
    function initSceneAndCamera() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x030712);
      scene.fog = new THREE.FogExp2(0x030712, 0.005);
      camera = new THREE.PerspectiveCamera(60, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
      camera.position.set(0, 1.2, 5);
    }

    // --- Setup Renderer ---
    function setupRenderer() {
      renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.2;
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      canvasContainer.appendChild(renderer.domElement);
    }

    // --- Setup Lighting ---
    function setupLighting() {
      const ambientLight = new THREE.AmbientLight(0x303050, 0.5);
      scene.add(ambientLight);
      const mainLight = new THREE.DirectionalLight(0x9090ff, 1.0);
      mainLight.position.set(5, 10, 7.5);
      mainLight.castShadow = true;
      mainLight.shadow.mapSize.width = 1024;
      mainLight.shadow.mapSize.height = 1024;
      scene.add(mainLight);
      const fillLight = new THREE.DirectionalLight(0x3040c0, 0.5);
      fillLight.position.set(-5, 0, -7.5);
      scene.add(fillLight);
      const pointLight1 = new THREE.PointLight(0x3060ff, 1, 10);
      pointLight1.position.set(3, 1, 3);
      scene.add(pointLight1);
      const pointLight2 = new THREE.PointLight(0x60ffff, 1, 10);
      pointLight2.position.set(-3, 1, -3);
      scene.add(pointLight2);
    }

    // --- Setup Post-Processing Effects ---
    function setupPostProcessing() {
      composer = new EffectComposer(renderer);
      const renderPass = new RenderPass(scene, camera);
      composer.addPass(renderPass);
      bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.2, 0.2, 0.9);
      composer.addPass(bloomPass);
      outlinePass = new OutlinePass(new THREE.Vector2(window.innerWidth, window.innerHeight), scene, camera);
      outlinePass.edgeStrength = 3.0;
      outlinePass.edgeGlow = 1.0;
      outlinePass.edgeThickness = 1.5;
      outlinePass.pulsePeriod = 2;
      outlinePass.visibleEdgeColor.set(0x4F46E5);
      outlinePass.hiddenEdgeColor.set(0x4F46E5);
      composer.addPass(outlinePass);
    }

    // --- Setup Controls ---
    function setupControls() {
      controls = new OrbitControls(camera, renderer.domElement);
      controls.target.set(0, 1.0, 0);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.screenSpacePanning = true;
      controls.minDistance = 1;
      controls.maxDistance = 20;
      controls.autoRotate = false;
      controls.autoRotateSpeed = 0.5;
      controls.update();
    }

    // --- Setup Raycaster ---
    function setupRaycaster() {
      raycaster = new THREE.Raycaster();
      mouse = new THREE.Vector2();
    }

    // --- Setup AR Elements ---
    function setupARElements() {
      arLabels = {
        head: document.getElementById('head-label'),
        torso: document.getElementById('torso-label'),
        arm: document.getElementById('arm-label'),
        leg: document.getElementById('leg-label')
      };
    }

    // --- Load Environment Map for Reflections ---
    function loadEnvironmentMap() {
      new RGBELoader()
        .setPath('https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/')
        .load('royal_esplanade_1k.hdr', function(texture) {
          texture.mapping = THREE.EquirectangularReflectionMapping;
          scene.environment = texture;
        });
    }

    // --- Load 3D Model ---
    function loadModel() {
      const loader = new GLTFLoader();
      const modelUrl = './human_body.glb';
      progressBar.style.width = '5%';
      loadingText.textContent = 'Initializing model loader...';
      loader.load(
        modelUrl,
        function (gltf) {
          model = gltf.scene;
          optimizeAndCenterModel(model);
          applySciFiMaterial(model);
          scene.add(model);
          updateControlsForModel();
          completeLoading();
        },
        function (xhr) {
          const percentLoaded = Math.round((xhr.loaded / xhr.total) * 100);
          progressBar.style.width = percentLoaded + '%';
          loadingText.textContent = `Loading 3D model... ${percentLoaded}%`;
          if (percentLoaded === 100) {
            loadingText.textContent = 'Processing geometry...';
            setTimeout(() => {
              loadingText.textContent = 'Applying materials...';
              setTimeout(() => {
                loadingText.textContent = 'Finalizing render...';
              }, 500);
            }, 500);
          }
        },
        function (error) {
          loadingOverlay.innerHTML = `
            <div class="text-center p-6">
              <h2 class="text-2xl font-bold text-red-500 mb-4">Error Loading Model</h2>
              <p class="text-gray-300 mb-4">We encountered a problem while loading the 3D model.</p>
              <p class="text-sm text-gray-400 mb-6">${error.message || 'Unknown error'}</p>
              <button onclick="location.reload()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md">
                Try Again
              </button>
            </div>
          `;
        }
      );
    }

    // --- Optimize and Center Model ---
    function optimizeAndCenterModel(model) {
      const box = new THREE.Box3().setFromObject(model);
      const center = box.getCenter(new THREE.Vector3());
      const size = box.getSize(new THREE.Vector3());
      const maxDim = Math.max(size.x, size.y, size.z);
      const desiredHeight = 3.0
