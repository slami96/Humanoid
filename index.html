<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Body</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic styling for body and canvas */
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        /* Ensure canvas fills its container */
        #canvas-container { flex-grow: 1; height: 100vh; position: relative; }
        #canvas-container canvas { display: block; width: 100%; height: 100%; }
        /* Style for the info panel */
        #info-panel {
            width: 300px; /* Adjust width as needed */
            height: 100vh;
            overflow-y: auto;
            flex-shrink: 0; /* Prevent info panel from shrinking */
        }
        /* Basic loading indicator style */
        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2em;
            background-color: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: 8px;
            display: none; /* Hidden by default */
            z-index: 10; /* Ensure it's above the canvas */
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="flex h-screen">
        <div id="info-panel" class="p-6 bg-gray-800 rounded-r-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-4">Body Information</h2>
            <div id="info-content">
                <p class="text-gray-400">Loading model... Click on a body part after it appears.</p>
            </div>
        </div>

        <div id="canvas-container">
            <div id="loading-indicator">Loading Model... 0%</div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        // Import necessary Three.js modules
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- Global Variables ---
        let scene, camera, renderer, controls;
        let raycaster, mouse;
        let model; // Will hold the loaded GLB model scene
        const canvasContainer = document.getElementById('canvas-container');
        const infoContent = document.getElementById('info-content');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Initialization ---
        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111827); // Dark background

            // Camera
            camera = new THREE.PerspectiveCamera(75, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
            // *** ADJUSTED CAMERA POSITION: Moved further back (Z=5) and slightly lower (Y=1.2) ***
            // *** You might need to fine-tune these values based on your model's size/pivot ***
            camera.position.set(0, 1.2, 5);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            canvasContainer.appendChild(renderer.domElement);

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight2.position.set(-5, -5, -7.5);
            scene.add(directionalLight2);

            // Controls
            controls = new OrbitControls(camera, renderer.domElement);
            // *** ADJUSTED CONTROLS TARGET: Aim near the model's likely center ***
            // *** Fine-tune Y value (1.0) if the model's center is higher/lower ***
            controls.target.set(0, 1.0, 0);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.minDistance = 1;
            controls.maxDistance = 20;
            controls.update(); // Important after setting target

            // Raycaster
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // --- Load GLTF/GLB Model ---
            const loader = new GLTFLoader();
            const modelUrl = './human_body.glb'; // Assumes in root

            loadingIndicator.style.display = 'block';

            loader.load(
                modelUrl,
                // Success callback
                function (gltf) {
                    loadingIndicator.style.display = 'none';
                    model = gltf.scene;

                    // --- Center and Scale Model (Optional but Recommended) ---
                    // Calculate bounding box
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());

                    // Rescale model to fit within a certain size (e.g., height of 3 units)
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const desiredHeight = 3.0; // Target height for the model
                    const scale = desiredHeight / maxDim;
                    model.scale.set(scale, scale, scale);

                    // Recalculate box after scaling
                    box.setFromObject(model);
                    box.getCenter(center); // Update center based on new scale

                    // Reposition model so its bottom rests near the origin's Y=0
                    model.position.sub(center); // Move center to origin
                    model.position.y += (size.y * scale / 2); // Lift model so bottom is at y=0

                    // Adjust controls target to new center AFTER scaling/positioning
                    // controls.target.copy(model.position).add(new THREE.Vector3(0, size.y * scale / 2, 0)); // Target center mass
                    controls.target.set(0, size.y * scale * 0.5, 0); // Target vertical center after repositioning
                    controls.update();
                    // --- End Centering and Scaling ---


                    scene.add(model);

                    console.log('Model loaded successfully:', model);
                    model.traverse((child) => {
                        if (child.isMesh) {
                            console.log('Found mesh:', child.name, child);
                        }
                    });

                    updateInfoPanel('', 'Model loaded. Click on a body part.');
                },
                // Progress callback
                function (xhr) {
                    const percentLoaded = Math.round((xhr.loaded / xhr.total) * 100);
                    loadingIndicator.textContent = `Loading Model... ${percentLoaded}%`;
                },
                // Error callback
                function (error) {
                    loadingIndicator.style.display = 'none';
                    console.error('An error happened loading the model:', error);
                    infoContent.innerHTML = `<p class="text-red-500">Error loading 3D model (${modelUrl}). Check file path/integrity. See console.</p>`;
                }
            );
            // --- End Model Loading ---

            // Event Listeners
            window.addEventListener('resize', onWindowResize);
            canvasContainer.addEventListener('click', onClick);

            // Start animation loop
            animate();
        }

        // --- Handle Window Resize ---
        function onWindowResize() {
            if (!renderer || !camera || !canvasContainer) return;
            camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        }

        // --- Handle Click Events ---
        function onClick(event) {
            if (!model) return;

            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(model, true);

            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                // *** ADDED DETAILED LOGGING ***
                console.log('Intersection Data:', intersects[0]);
                console.log('Clicked Object Raw:', clickedObject);

                // *** REFINED NAME DETECTION ***
                let objectName = clickedObject.name;
                let parentName = clickedObject.parent ? clickedObject.parent.name : null;
                console.log(`Clicked Mesh Name: "${objectName}", Parent Name: "${parentName}"`);

                let partName = 'Unknown Part'; // Default
                let description = `You clicked on an object.`;

                // Try to find the most specific useful name
                if (objectName && objectName !== '' && !objectName.toLowerCase().includes('group')) {
                    // Use the mesh's own name if it seems specific
                    partName = objectName;
                } else if (parentName && parentName !== '' && parentName !== 'Scene' && !parentName.toLowerCase().includes('group')) {
                    // Fallback to parent's name if mesh name isn't useful
                    partName = parentName;
                } else if (objectName && objectName !== '') {
                     // Use the object name even if it includes 'group' as a last resort before 'Unknown'
                     partName = objectName;
                }
                 // If partName is still 'Unknown Part', it means neither mesh nor parent had a useful name.

                description = `Clicked: ${partName}`; // Default description using the best name found

                // *** APPLY SPECIFIC INFO BASED ON THE DETERMINED partName ***
                if (partName.toLowerCase().includes('head')) {
                     partName = 'Head'; // Clean up name
                     description = 'The head contains the brain, sensory organs (eyes, ears, nose, mouth), and the start of the digestive/respiratory tracts.';
                } else if (partName.toLowerCase().includes('chest') || partName.toLowerCase().includes('torso')) {
                     partName = 'Chest/Torso';
                     description = 'The torso houses vital organs like the heart, lungs, liver, stomach, and intestines.';
                } else if (partName.toLowerCase().includes('arm')) {
                     partName = 'Arm';
                     description = 'Arms are used for reaching, grasping, lifting, and interacting with the environment.';
                } else if (partName.toLowerCase().includes('leg')) {
                     partName = 'Leg';
                     description = 'Legs provide support, balance, and locomotion (walking, running).';
                } else if (partName.toLowerCase().includes('foot') || partName.toLowerCase().includes('feet')) {
                     partName = 'Foot / Feet';
                     description = 'Feet provide support, balance, and absorb shock during movement.';
                }
                // *** Add more 'else if' conditions here based on the names you see logged in the console ***

                updateInfoPanel(partName, description);

            } else {
                // Clicked on the background
                updateInfoPanel('', 'Click on a body part in the model.');
            }
        }

        // --- Update Information Panel ---
        function updateInfoPanel(title, text) {
            // Ensure title is treated as a string, even if it's null/undefined from name checks
            const displayTitle = title || 'Info';
            infoContent.innerHTML = `
                <h3 class="text-xl font-semibold mb-2 text-blue-400">${displayTitle}</h3>
                <p>${text}</p>
            `;
             if (!title && !text) { // Handle case where both are empty (e.g., background click)
                 infoContent.innerHTML = `<p class="text-gray-400">Click on a body part.</p>`;
             } else if (!title) { // Handle case where only title is missing
                 infoContent.innerHTML = `<p>${text}</p>`;
             }
        }


        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (renderer) renderer.render(scene, camera);
        }

        // --- Start ---
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

    </script>

</body>
</html>
