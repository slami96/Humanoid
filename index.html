<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Human Anatomy Explorer | Interactive 3D Learning</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap">
  <style>
    /* Custom Science/Space Theme (from user code) */
    :root {
      --primary: #4F46E5; /* Indigo-600 */
      --primary-hover: #4338CA; /* Indigo-700 */
      --secondary: #10B981; /* Emerald-500 */
      --accent: #06B6D4; /* Cyan-500 */
      --dark-bg: #111827; /* Gray-900 */
      --panel-bg: #1F2937; /* Gray-800 */
      --text-primary: #F9FAFB; /* Gray-50 */
      --text-secondary: #D1D5DB; /* Gray-300 */
      --glow-primary: 0 0 15px rgba(79, 70, 229, 0.5); /* Indigo glow */
      --glow-secondary: 0 0 15px rgba(16, 185, 129, 0.5); /* Emerald glow */
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      overflow: hidden;
      background-color: var(--dark-bg);
      color: var(--text-primary);
    }
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Rajdhani', sans-serif;
      font-weight: 600;
    }
    .sci-panel {
      background-color: rgba(31, 41, 55, 0.85); /* Gray-800 with opacity */
      backdrop-filter: blur(10px);
      border: 1px solid rgba(79, 70, 229, 0.2); /* Indigo border */
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), var(--glow-primary);
    }
    .sci-title {
      position: relative;
      overflow: hidden;
    }
    .sci-title::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
      background: linear-gradient(180deg, var(--primary), var(--secondary));
    }
    .sci-badge {
      background: linear-gradient(45deg, var(--primary), var(--accent));
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .sci-highlight {
      color: var(--secondary);
      font-weight: 500;
    }
    .glow-text {
      text-shadow: 0 0 8px rgba(79, 70, 229, 0.6); /* Indigo glow */
    }
    /* Canvas Styling */
    #canvas-container {
      flex-grow: 1;
      height: 100vh;
      position: relative;
    }
    #canvas-container canvas {
      display: block;
      width: 100%;
      height: 100%;
      cursor: grab;
    }
    #canvas-container canvas:active {
      cursor: grabbing;
    }
    /* Sidebar Panel */
    #info-panel {
      width: 375px;
      height: 100vh;
      overflow-y: auto;
      flex-shrink: 0;
      background-color: var(--panel-bg);
      transition: transform 0.3s ease;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) var(--panel-bg);
    }
    #info-panel::-webkit-scrollbar { width: 8px; }
    #info-panel::-webkit-scrollbar-track { background: var(--panel-bg); }
    #info-panel::-webkit-scrollbar-thumb { background-color: var(--primary); border-radius: 20px; }
    /* Loading Overlay */
    #loading-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(17, 24, 39, 0.95); /* Gray-900 with opacity */
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 50;
      transition: opacity 0.5s ease-out; /* Fade out transition */
    }
    #loading-overlay.hidden {
        opacity: 0;
        pointer-events: none; /* Allow interaction with elements underneath */
    }
    .progress-bar {
      width: 300px; height: 8px; background-color: rgba(255, 255, 255, 0.1);
      border-radius: 4px; overflow: hidden; margin-top: 2rem;
    }
    .progress-fill {
      height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary));
      width: 0%; transition: width 0.3s ease; box-shadow: var(--glow-primary);
    }
    /* Controls Guide */
    #controls-guide {
      position: absolute; bottom: 1rem; right: 1rem;
      background-color: rgba(31, 41, 55, 0.8); color: white; font-size: 0.75rem;
      line-height: 1.25rem; padding: 0.75rem; border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      z-index: 10; max-width: 250px; backdrop-filter: blur(8px);
      border: 1px solid rgba(79, 70, 229, 0.15); /* Indigo border */
      transition: opacity 0.3s; opacity: 0.7;
    }
    #controls-guide:hover { opacity: 1; }
    /* HUD Elements */
    .hud-element { position: absolute; pointer-events: none; z-index: 5; font-family: 'Rajdhani', sans-serif; }
    .body-stat { top: 1rem; left: 1rem; font-size: 0.8rem; padding: 0.75rem; color: var(--text-secondary); max-width: 250px; }
    .body-scan-line {
      position: absolute; width: 100%; height: 4px;
      background: linear-gradient(90deg, transparent, rgba(79, 70, 229, 0.2), rgba(79, 70, 229, 0.5), rgba(79, 70, 229, 0.2), transparent);
      z-index: 10; pointer-events: none; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4);
      opacity: 0; animation: scanAnimation 8s infinite;
    }
    @keyframes scanAnimation {
      0% { top: 0%; opacity: 1; } 90% { top: 100%; opacity: 1; }
      91% { opacity: 0; } 100% { top: 0%; opacity: 0; }
    }
    /* HUD Trackers (Placeholder styling from user code) */
    .tracker {
      position: absolute; width: 80px; height: 80px; pointer-events: none; z-index: 5;
      border: 1px solid rgba(79, 70, 229, 0.5); border-radius: 50%; transform: translate(-50%, -50%);
      background: radial-gradient(circle, rgba(79, 70, 229, 0.15) 0%, rgba(16, 185, 129, 0.05) 70%, transparent 100%);
      box-shadow: 0 0 15px rgba(79, 70, 229, 0.3); opacity: 0; transition: opacity 0.5s;
    }
    .tracker::before, .tracker::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; }
    .tracker::before { width: 60px; height: 60px; border: 1px dashed rgba(79, 70, 229, 0.5); animation: rotate 10s linear infinite; }
    .tracker::after { width: 10px; height: 10px; background-color: rgba(16, 185, 129, 0.8); box-shadow: 0 0 8px rgba(16, 185, 129, 0.8); }
    @keyframes rotate { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
    /* AR Styled Labels (Placeholder styling from user code) */
    .ar-label { position: absolute; color: var(--secondary); font-size: 0.7rem; letter-spacing: 0.05em; pointer-events: none; z-index: 5; transition: opacity 0.5s; opacity: 0; text-shadow: 0 0 5px var(--secondary); }
    .ar-label::after { content: ''; position: absolute; top: 50%; width: 30px; height: 1px; background-color: var(--secondary); opacity: 0.5; }
    .ar-label-left { text-align: right; } .ar-label-left::after { right: -35px; }
    .ar-label-right { text-align: left; } .ar-label-right::after { left: -35px; }
    /* Info Card Animation */
    .info-card { opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
    .info-card.show { opacity: 1; transform: translateY(0); }
    /* Responsive Styles */
    @media (max-width: 768px) {
      .flex-col-reverse { flex-direction: column-reverse; }
      #info-panel { width: 100%; height: 40%; min-height: 250px; max-height: 50%; }
      #canvas-container { height: 60%; }
      .panel-toggle { display: block !important; }
      #info-panel.collapsed { transform: translateY(calc(100% - 40px)); }
      #toggle-panel-icon { transform: rotate(0deg); transition: transform 0.3s; }
      #info-panel.collapsed #toggle-panel-icon { transform: rotate(180deg); }
    }
  </style>
</head>
<body>
  <div id="loading-overlay">
    <h2 class="text-4xl font-bold text-center mb-2 glow-text">Loading Human Anatomy Explorer</h2>
    <p class="text-gray-400 mb-6">Preparing high-resolution 3D model...</p>
    <div class="progress-bar"><div class="progress-fill" id="progress-bar"></div></div>
    <p id="loading-text" class="mt-4 text-sm text-gray-300">Establishing connection...</p>
  </div>

  <div class="flex h-screen md:flex-row flex-col-reverse">
    <div id="info-panel" class="relative">
      <button id="panel-toggle" class="panel-toggle hidden absolute top-4 right-4 md:hidden bg-gray-700 p-2 rounded-md hover:bg-gray-600 focus:outline-none z-20">
        <svg id="toggle-panel-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
      <div class="p-6 border-b border-gray-700">
        <div class="sci-title pl-6 mb-4">
          <h1 class="text-2xl font-bold">Human Anatomy Explorer</h1>
          <p class="text-sm text-gray-400">Interactive 3D Learning Platform</p>
        </div>
        <div class="flex items-center space-x-2 mb-1">
          <div class="sci-badge"><span class="opacity-60">SCI</span><span>SCAN</span></div>
          <div class="h-2 w-2 rounded-full bg-green-400 animate-pulse"></div>
          <div class="text-xs text-green-400">ACTIVE</div>
        </div>
      </div>
      <div id="info-content" class="px-6 py-4 space-y-4">
        <div class="sci-panel p-4 info-card show">
          <p class="text-gray-300 text-sm">Welcome! Click a part or marker.</p>
        </div>
      </div>
    </div>

    <div id="canvas-container" class="relative">
      <div class="hud-element body-stat sci-panel">
        <div class="text-xs text-indigo-300 mb-1">ANATOMICAL ANALYSIS</div>
        <div class="text-xs"><span>SYSTEM</span>: <span id="system-status" class="text-green-400">STANDBY</span></div>
        <div class="text-xs"><span>ORGANS MAPPED</span>: <span id="organs-mapped" class="text-yellow-400">0</span></div>
      </div>
      <div class="body-scan-line"></div>
      <div id="body-tracker" class="tracker"></div>
      <div id="head-label" class="ar-label ar-label-left"></div>
      <div id="torso-label" class="ar-label ar-label-right"></div>
      <div id="arm-label" class="ar-label ar-label-left"></div>
      <div id="leg-label" class="ar-label ar-label-right"></div>

      <div id="controls-guide" class="sci-panel">
        <div class="text-xs text-indigo-300 mb-1 font-semibold">INTERFACE CONTROLS</div>
        <div class="grid grid-cols-2 gap-x-3 gap-y-1 text-xs">
          <span>ROTATE VIEW</span><span class="text-gray-300">Left Mouse / Drag</span>
          <span>ZOOM</span><span class="text-gray-300">Mouse Wheel</span>
          <span>PAN</span><span class="text-gray-300">Right Mouse / Drag</span>
          <span>RESET VIEW</span><span class="text-gray-300">Double Click</span>
          <span>DEBUG ZONES</span><span class="text-gray-300">Press 'Z'</span>
        </div>
      </div>
    </div>
  </div>

  <audio id="sound-click" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-modern-technology-select-3124.mp3" type="audio/mpeg"></audio>
  <audio id="sound-hover" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-interface-hint-notification-911.mp3" type="audio/mpeg"></audio>
  <audio id="sound-scan" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-sci-fi-interface-zoom-890.mp3" type="audio/mpeg"></audio>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    // Removed unused imports (RGBELoader, Postprocessing) for clarity unless needed later

    // --- Global Variables ---
    let scene, camera, renderer, controls;
    let raycaster, mouse;
    let model;
    let initialCameraPosition = new THREE.Vector3();
    let initialControlsTarget = new THREE.Vector3();
    let zoneHelpers = []; // To hold Box3Helpers for visualization
    let zonesVisible = false; // State for toggling zone visibility
    let audioEnabled = true; // Assuming audio starts enabled

    // DOM elements
    const canvasContainer = document.getElementById('canvas-container');
    const infoContent = document.getElementById('info-content');
    const loadingOverlay = document.getElementById('loading-overlay');
    const progressBar = document.getElementById('progress-bar');
    const loadingText = document.getElementById('loading-text');
    const panelToggle = document.getElementById('panel-toggle');
    const infoPanel = document.getElementById('info-panel');
    const systemStatus = document.getElementById('system-status');
    const organsMapped = document.getElementById('organs-mapped');

    // Audio elements
    const soundClick = document.getElementById('sound-click');
    const soundHover = document.getElementById('sound-hover');
    const soundScan = document.getElementById('sound-scan');

    // --- Body Parts Data with Zones ---
    // Structure to hold part info and its corresponding Box3 zone
    // Coordinates below are examples and NEED ADJUSTMENT based on visualization
    const bodyPartsData = {
        head: {
            name: "Head", system: "Nervous System",
            description: `<p>The head houses the brain...</p>`, // (Content truncated for brevity)
            composition: ["Brain", "Skull", "Eyes", "Ears", "Nose", "Mouth"],
            functions: ["Processes sensory info", "Controls cognition", /*...*/],
            zone: new THREE.Box3(new THREE.Vector3(-0.5, 2.6, -0.5), new THREE.Vector3(0.5, 3.5, 0.5)) // User's Head Zone
        },
        chest: {
            name: "Chest/Torso", system: "Respiratory & Cardiovascular",
            description: `<p>The chest, or thoracic cavity...</p>`,
            composition: ["Heart", "Lungs", "Ribcage", /*...*/],
            functions: ["Circulates blood", "Gas exchange", /*...*/],
            zone: new THREE.Box3(new THREE.Vector3(-0.8, 1.5, -0.5), new THREE.Vector3(0.8, 2.6, 0.5)) // User's Chest Zone
        },
        abdomen: {
            name: "Abdomen", system: "Digestive & Urinary",
            description: `<p>The abdomen contains the majority...</p>`,
            composition: ["Stomach", "Liver", "Intestines", /*...*/],
            functions: ["Digests nutrients", "Filters waste", /*...*/],
            // *** ADJUSTED ABDOMEN ZONE COORDINATES ***
            zone: new THREE.Box3(
                new THREE.Vector3(-0.6, 0.9, -0.4), // Raised minY from 0.5 to 0.9, narrowed X/Z slightly
                new THREE.Vector3(0.6, 1.5, 0.4)
            )
        },
        leftArm: {
            name: "Left Arm", system: "Musculoskeletal",
            description: `<p>The arm extends from the shoulder...</p>`,
            composition: ["Humerus", "Radius", "Ulna", /*...*/],
            functions: ["Lifting", "Fine motor skills", /*...*/],
            zone: new THREE.Box3(new THREE.Vector3(-1.5, 0.5, -0.6), new THREE.Vector3(-0.5, 2.6, 0.6)) // User's Left Arm Zone
        },
        rightArm: {
            name: "Right Arm", system: "Musculoskeletal",
            description: `<p>The arm extends from the shoulder...</p>`, // (Content truncated)
            composition: ["Humerus", "Radius", "Ulna", /*...*/],
            functions: ["Lifting", "Fine motor skills", /*...*/],
            zone: new THREE.Box3(new THREE.Vector3(0.5, 0.5, -0.6), new THREE.Vector3(1.5, 2.6, 0.6)) // User's Right Arm Zone
        },
        // Assuming user added a legs zone based on previous code
        legs: {
            name: "Legs / Lower Body", system: "Musculoskeletal",
            description: `<p>The legs support the body...</p>`,
            composition: ["Femur", "Tibia", "Fibula", /*...*/],
            functions: ["Support", "Locomotion", /*...*/],
            // Example Leg Zone - User needs to confirm/adjust this based on their edits
            zone: new THREE.Box3(new THREE.Vector3(-0.6, 0.0, -0.5), new THREE.Vector3(0.6, 0.9, 0.5)) // Adjusted maxY to not overlap new abdomen minY
        }
    };

    // --- Dot Visualization ---
    const dotGeometry = new THREE.SphereGeometry(0.05, 16, 8); // Slightly larger radius
    const dotMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 }); // Yellow, opaque

    // --- Initialization ---
    function init() {
        scene = new THREE.Scene();
        // Environment setup (optional, from user code - requires HDR)
        // new RGBELoader()
        //     .setPath('path/to/your/hdrs/') // Adjust path
        //     .load('environment.hdr', function (texture) {
        //         texture.mapping = THREE.EquirectangularReflectionMapping;
        //         scene.background = texture;
        //         scene.environment = texture;
        //     });
        scene.background = new THREE.Color(0x111827); // Fallback background

        camera = new THREE.PerspectiveCamera(60, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
        camera.position.set(0, 1.5, 5.5); // Slightly adjusted initial camera

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); // Alpha true if using env background
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
        renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping; // Good tone mapping
        renderer.outputEncoding = THREE.sRGBEncoding; // Correct color space
        canvasContainer.appendChild(renderer.domElement);

        // Lights
        const hemiLight = new THREE.HemisphereLight(0xadcafc, 0x404040, 1.5);
        scene.add(hemiLight);
        const dirLight1 = new THREE.DirectionalLight(0xffffff, 1.2); // Slightly increased intensity
        dirLight1.position.set(8, 15, 10);
        scene.add(dirLight1);
        const dirLight2 = new THREE.DirectionalLight(0xffffff, 0.6);
        dirLight2.position.set(-8, -5, -10);
        scene.add(dirLight2);

        controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 1.2, 0); // Adjusted initial target
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.screenSpacePanning = true;
        controls.minDistance = 1;
        controls.maxDistance = 25; // Increased max distance
        controls.update();

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();

        // --- Load Model ---
        loadModel(); // Call load function

        // Event Listeners
        window.addEventListener('resize', onWindowResize);
        canvasContainer.addEventListener('click', onClick);
        canvasContainer.addEventListener('dblclick', onDoubleClick);
        window.addEventListener('keydown', onKeyDown); // Listener for 'Z' key

        // Mobile Panel Toggle
        if (panelToggle) {
            panelToggle.addEventListener('click', () => {
                infoPanel.classList.toggle('collapsed');
            });
        }

        // Start animation loop
        animate();
        // Show initial welcome info
        showWelcomeInfo();
        // Update HUD
        updateHUD();
    }

    // --- Load GLTF Model ---
    function loadModel() {
        const loader = new GLTFLoader();
        const modelUrl = './human_body.glb'; // Ensure this path is correct
        loadingOverlay.classList.remove('hidden'); // Show loading overlay

        loader.load(
            modelUrl,
            function (gltf) { // Success
                model = gltf.scene;

                // Center and Scale
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const desiredHeight = 3.0; // Target height
                const scale = desiredHeight / maxDim;
                model.scale.set(scale, scale, scale);
                box.setFromObject(model);
                box.getCenter(center);
                model.position.sub(center);
                model.position.y += (size.y * scale / 2); // Align base near Y=0
                scene.add(model);

                // Adjust controls target and save initial state
                const modelCenterY = model.position.y + (size.y * scale * 0.5);
                controls.target.set(model.position.x, modelCenterY, model.position.z);
                initialCameraPosition.copy(camera.position);
                initialControlsTarget.copy(controls.target);
                controls.saveState();
                controls.update();

                // Add Zone Dots after model is positioned
                addZoneDots();

                // Hide loading overlay
                loadingOverlay.classList.add('hidden');
                console.log('Model loaded successfully.');
                systemStatus.textContent = "READY";
                playSound(soundScan); // Play sound on load

            },
            function (xhr) { // Progress
                const percentLoaded = (xhr.loaded / xhr.total) * 100;
                progressBar.style.width = percentLoaded + '%';
                loadingText.textContent = `Loading model... ${Math.round(percentLoaded)}%`;
            },
            function (error) { // Error
                console.error('Error loading 3D model:', error);
                loadingText.textContent = 'Error loading model. Please check file path and console.';
                systemStatus.textContent = "ERROR";
                systemStatus.classList.remove('text-green-400');
                systemStatus.classList.add('text-red-400');
            }
        );
    }

    // --- Add Zone Dots ---
    function addZoneDots() {
        // Clear existing dots first if any (e.g., if model reloads)
        scene.children.filter(child => child.name.includes("Zone Marker")).forEach(dot => scene.remove(dot));

        Object.values(bodyPartsData).forEach(partData => {
            if (partData.zone) {
                const zoneCenter = partData.zone.getCenter(new THREE.Vector3());
                const dotMesh = new THREE.Mesh(dotGeometry, dotMaterial);
                dotMesh.position.copy(zoneCenter);
                dotMesh.name = partData.name + " Zone Marker";
                scene.add(dotMesh);
            }
        });
        console.log("Added/Updated zone markers.");
    }


    // --- Handle Resize ---
    function onWindowResize() {
        if (!renderer || !camera || !canvasContainer) return;
        camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        // composer?.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight); // If using EffectComposer
    }

    // --- Handle Double Click ---
    function onDoubleClick() {
        if (!controls || !initialCameraPosition || !initialControlsTarget) return;
        console.log("Resetting view...");
        camera.position.copy(initialCameraPosition);
        controls.target.copy(initialControlsTarget);
        controls.update();
    }

    // --- Handle Key Down (for 'Z' key) ---
    function onKeyDown(event) {
        if (event.key.toLowerCase() === 'z') {
            toggleZoneHelpers();
        }
    }

    // --- Toggle Zone Visualization ---
    function toggleZoneHelpers() {
        zonesVisible = !zonesVisible;
        if (zonesVisible) {
            console.log("Showing zone helpers...");
            if (zoneHelpers.length === 0) { // Create helpers if they don't exist
                 const colors = { Head: 0xff0000, 'Chest/Torso': 0x00ff00, Abdomen: 0x00ffff, 'Left Arm': 0x0000ff, 'Right Arm': 0xffff00, 'Legs / Lower Body': 0xff00ff };
                 Object.values(bodyPartsData).forEach(partData => {
                     if (partData.zone) {
                         const helperColor = colors[partData.name] || 0x888888;
                         const helper = new THREE.Box3Helper(partData.zone, helperColor);
                         helper.name = partData.name + " Zone Helper";
                         scene.add(helper);
                         zoneHelpers.push(helper);
                     }
                 });
            } else { // Just make existing helpers visible
                zoneHelpers.forEach(helper => helper.visible = true);
            }
        } else {
            console.log("Hiding zone helpers...");
            zoneHelpers.forEach(helper => helper.visible = false);
        }
    }


    // --- Handle Click ---
    function onClick(event) {
        if (!model) return;

        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObject(model, true);

        if (intersects.length > 0) {
            const clickPoint = intersects[0].point;
            console.log('Checking point:', clickPoint);

            let hitDetected = false;
            // Iterate through body parts data to find matching zone
            for (const key in bodyPartsData) {
                const partData = bodyPartsData[key];
                if (partData.zone && partData.zone.containsPoint(clickPoint)) {
                    console.log("Direct hit on zone:", key);
                    displayPartInfo(partData);
                    playSound(soundClick);
                    hitDetected = true;
                    break; // Stop checking once a zone is hit
                }
            }

            if (!hitDetected) {
                console.log("Clicked model, but no specific zone hit at this point.");
                showWelcomeInfo("Clicked model, but no specific zone hit."); // Or provide default info
            }

        } else {
            // Clicked on background
            showWelcomeInfo(); // Show default info
        }
    }

    // --- Display Part Information ---
    function displayPartInfo(partData) {
        selectedPart = partData; // Store selected part data
        updateHUD(); // Update HUD elements

        // Create HTML content for the info panel
        let functionsHTML = partData.functions.map(f => `<li class="text-xs text-gray-300">${f}</li>`).join('');
        let compositionHTML = partData.composition.map(c => `<span class="inline-block bg-gray-600 text-gray-200 text-xs px-2 py-0.5 rounded mr-1 mb-1">${c}</span>`).join('');

        infoContent.innerHTML = `
            <div class="sci-panel p-4 info-card">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-semibold text-indigo-300 glow-text">${partData.name}</h3>
                    <span class="text-xs text-gray-400">${partData.system || ''}</span>
                </div>
                <div class="space-y-3 text-sm">
                    ${partData.description}
                    <div>
                        <h4 class="text-sm font-semibold text-gray-300 mb-1">Key Functions:</h4>
                        <ul class="list-disc list-inside space-y-1">${functionsHTML}</ul>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-gray-300 mb-1">Main Composition:</h4>
                        <div>${compositionHTML}</div>
                    </div>
                </div>
            </div>
        `;
        // Trigger animation
        setTimeout(() => {
            const card = infoContent.querySelector('.info-card');
            if (card) card.classList.add('show');
        }, 50); // Small delay to ensure element is rendered
    }

    // --- Show Welcome/Default Info ---
    function showWelcomeInfo(message = "Click a body part or marker.") {
         selectedPart = null; // Clear selection
         updateHUD();

         infoContent.innerHTML = `
            <div class="sci-panel p-4 info-card">
                 <p class="text-gray-300 text-sm">
                    Welcome to the <span class="sci-highlight">Human Anatomy Explorer</span>.
                 </p>
                 <p class="text-gray-300 text-sm mt-2">
                    ${message} Use controls guide (bottom-right) or press 'Z' to toggle zone helpers.
                 </p>
             </div>
         `;
         // Trigger animation
         setTimeout(() => {
            const card = infoContent.querySelector('.info-card');
            if (card) card.classList.add('show');
        }, 50);
    }

     // --- Update HUD Elements ---
    function updateHUD() {
        if (systemStatus) {
            systemStatus.textContent = selectedPart ? selectedPart.system.toUpperCase() : "STANDBY";
            systemStatus.className = selectedPart ? 'text-yellow-400' : 'text-green-400';
        }
        if (organsMapped) {
            organsMapped.textContent = Object.keys(bodyPartsData).length; // Update count based on data
        }
        // Add logic for tracker and AR labels if implemented fully
    }

    // --- Play Sound Utility ---
    function playSound(audioElement) {
        if (audioEnabled && audioElement) {
            audioElement.currentTime = 0; // Rewind to start
            audioElement.play().catch(e => console.log("Audio play failed:", e)); // Play and catch errors
        }
    }

    // --- Animation Loop ---
    function animate() {
        requestAnimationFrame(animate);
        if (controls) {
            controls.update(); // Update controls if damping enabled
        }
        // Add updates for tracker/AR labels here if implemented
        renderer.render(scene, camera); // Render the scene
        // composer?.render(); // If using EffectComposer
    }

    // --- Start ---
    init();

  </script>
</body>
</html>
