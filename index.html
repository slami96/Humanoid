<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Body</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic styling for body and canvas */
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        /* Ensure canvas fills its container */
        #canvas-container { flex-grow: 1; height: 100vh; position: relative; /* Needed for absolute positioning of loader/error messages if added */ }
        #canvas-container canvas { display: block; width: 100%; height: 100%; }
        /* Style for the info panel */
        #info-panel {
            width: 300px; /* Adjust width as needed */
            height: 100vh;
            overflow-y: auto;
            flex-shrink: 0; /* Prevent info panel from shrinking */
        }
        /* Style for highlighted state (example) */
        .highlighted {
            /* Example: Outline the clicked mesh - Requires more complex material handling */
            /* outline: 2px solid yellow; */
        }
        /* Basic loading indicator style (optional) */
        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2em;
            background-color: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: 8px;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="flex h-screen">
        <div id="info-panel" class="p-6 bg-gray-800 rounded-r-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-4">Body Information</h2>
            <div id="info-content">
                <p class="text-gray-400">Loading model... Click on a body part after it appears.</p>
                </div>
        </div>

        <div id="canvas-container">
            <div id="loading-indicator">Loading Model... 0%</div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        // Import necessary Three.js modules
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        // *** STEP 1: Import GLTFLoader ***
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- Global Variables ---
        let scene, camera, renderer, controls;
        let raycaster, mouse;
        let model; // Will hold the loaded GLB model scene
        // let placeholderMesh; // Placeholder no longer primary, keep commented out or remove
        const canvasContainer = document.getElementById('canvas-container');
        const infoContent = document.getElementById('info-content');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Initialization ---
        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111827); // Dark background

            // Camera
            camera = new THREE.PerspectiveCamera(75, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 4); // Adjust camera position slightly for a typical human model view

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            canvasContainer.appendChild(renderer.domElement); // Add canvas to the container

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0); // Slightly brighter ambient
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5); // Keep directional light
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.8); // Add another light from a different angle
            directionalLight2.position.set(-5, -5, -7.5);
            scene.add(directionalLight2);


            // Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 1, 0); // Point controls towards the center of a typical human model height
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.minDistance = 1; // Adjust min distance
            controls.maxDistance = 20; // Adjust max distance
            controls.update(); // Important after setting target

            // Raycaster
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // --- Remove or Comment Out Placeholder ---
            /*
            const geometry = new THREE.SphereGeometry(1.5, 32, 32);
            const material = new THREE.MeshStandardMaterial({ color: 0x3b82f6, metalness: 0.3, roughness: 0.6 });
            placeholderMesh = new THREE.Mesh(geometry, material);
            placeholderMesh.name = "Placeholder Body";
            scene.add(placeholderMesh);
            */
            // --- End Placeholder ---

            // --- STEP 2 & 4: Load your GLTF/GLB Model ---
            const loader = new GLTFLoader();
            // *** STEP 3: Set correct path to your model ***
            const modelUrl = './human_body.glb'; // Assumes human_body.glb is in the same folder as the HTML file

            loadingIndicator.style.display = 'block'; // Show loading indicator

            loader.load(
                modelUrl,
                // Success callback
                function (gltf) {
                    loadingIndicator.style.display = 'none'; // Hide loading indicator
                    model = gltf.scene; // Assign the loaded scene graph to the global 'model' variable

                    // --- Optional: Adjust model scale, position, rotation ---
                    // model.scale.set(0.5, 0.5, 0.5); // Example: Make model half size
                    model.position.set(0, 0, 0); // Center the model at the origin
                    // model.rotation.y = Math.PI; // Example: Rotate model 180 degrees

                    // *** Add the loaded model to the scene ***
                    scene.add(model);

                    // --- Optional: Log model structure to console for debugging ---
                    console.log('Model loaded successfully:', model);
                    model.traverse((child) => {
                        if (child.isMesh) {
                            console.log('Found mesh:', child.name, child);
                            // You might assign userData here based on names if they exist
                            // if (child.name.includes('Head')) child.userData.bodyPart = 'Head';
                            // else if (child.name.includes('Arm')) child.userData.bodyPart = 'Arm';
                            // ... etc ...
                        }
                    });
                    // --- End Debugging ---

                    // Update info panel now that model is loaded
                    updateInfoPanel('', 'Model loaded. Click on a body part.');

                },
                // Progress callback (optional)
                function (xhr) {
                    const percentLoaded = Math.round((xhr.loaded / xhr.total) * 100);
                    console.log(percentLoaded + '% loaded');
                    loadingIndicator.textContent = `Loading Model... ${percentLoaded}%`;
                },
                // Error callback
                function (error) {
                    loadingIndicator.style.display = 'none'; // Hide loading indicator
                    console.error('An error happened loading the model:', error);
                    infoContent.innerHTML = `<p class="text-red-500">Error loading 3D model (${modelUrl}). Check the file path and ensure the file is in the repository. See console for details.</p>`;
                    // Optionally add a fallback or message
                }
            );
            // --- End Model Loading ---


            // Event Listeners
            window.addEventListener('resize', onWindowResize);
            canvasContainer.addEventListener('click', onClick);

            // Start animation loop
            animate();
        }

        // --- Handle Window Resize ---
        function onWindowResize() {
            if (!renderer || !camera || !canvasContainer) return; // Check if initialized
            camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        }

        // --- Handle Click Events ---
        function onClick(event) {
            if (!model) return; // Don't do anything if the model hasn't loaded yet

            // Calculate mouse position in normalized device coordinates (-1 to +1)
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            // Update the picking ray
            raycaster.setFromCamera(mouse, camera);

            // *** STEP 5: Check intersections with the loaded model ***
            // Pass the 'model' object (the loaded scene group) and 'true' to check recursively through all its children (meshes)
            const intersects = raycaster.intersectObject(model, true);

            if (intersects.length > 0) {
                // An object (part of your model) was clicked!
                const clickedObject = intersects[0].object; // Get the specific mesh that was clicked
                console.log('Clicked object:', clickedObject); // Log the clicked object details to the console

                // --- STEP 6: Display Information (Basic Example) ---
                // Attempt to get a meaningful name or identifier
                let partName = clickedObject.name || 'Unnamed Part'; // Use mesh name if available
                let description = `You clicked on: ${partName}.`;

                // *** IMPORTANT: Add specific logic here based on your model's structure ***
                // If your meshes have names like 'Head_Mesh', 'Arm_L_Mesh', etc.:
                if (partName.toLowerCase().includes('head')) {
                     partName = 'Head';
                     description = 'The head contains the brain, sensory organs (eyes, ears, nose, mouth), and the start of the digestive/respiratory tracts.';
                } else if (partName.toLowerCase().includes('chest') || partName.toLowerCase().includes('torso')) {
                     partName = 'Chest/Torso';
                     description = 'The torso houses vital organs like the heart, lungs, liver, stomach, and intestines.';
                } else if (partName.toLowerCase().includes('arm')) {
                     partName = 'Arm';
                     description = 'Arms are used for reaching, grasping, lifting, and interacting with the environment.';
                } else if (partName.toLowerCase().includes('leg')) {
                     partName = 'Leg';
                     description = 'Legs provide support, balance, and locomotion (walking, running).';
                }
                 // Add more specific checks based on the names you find when logging `clickedObject.name`

                // Or, if you assigned userData in the loader:
                // if (clickedObject.userData.bodyPart) {
                //     partName = clickedObject.userData.bodyPart;
                //     description = `Information about the ${partName}.`;
                //     // Add specific descriptions...
                // }

                updateInfoPanel(partName, description);

                // Optional: Add visual feedback (highlighting) - this is more advanced
                // highlightObject(clickedObject);

            } else {
                // Clicked on the background, clear info
                updateInfoPanel('', 'Click on a body part in the model.');
                // Optional: Remove any highlighting
                // unhighlightAll();
            }
        }

        // --- Update Information Panel ---
        function updateInfoPanel(title, text) {
            if (title) {
                infoContent.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2 text-blue-400">${title}</h3>
                    <p>${text}</p>
                `;
            } else {
                // Keep placeholder text if title is empty but text is provided
                infoContent.innerHTML = `<p class="text-gray-400">${text || 'Click on a body part.'}</p>`;
            }
        }

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update(); // Update controls only if they exist
            if (renderer) renderer.render(scene, camera); // Render scene only if renderer exists
        }

        // --- Start ---
        // Ensure DOM is fully loaded before initializing Three.js
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

    </script>

</body>
</html>
